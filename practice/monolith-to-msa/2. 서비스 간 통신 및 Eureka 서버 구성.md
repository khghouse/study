### 2. 서비스 간 통신 및 Eureka 서버 구성

- 멀티모듈로 변환한 후, 각 서비스 간의 직접적인 의존성을 제거하고 네트워크 통신으로 전환해야 합니다.
- Order Service가 User Service와 Product Service와 통신하도록 구조를 변경하고, 서비스 디스커버리를 위한 Eureka 서버를 구성합니다.

<br />

### 서비스 의존성이 있는 코드의 변경 전후

#### Before: 직접 의존성

```java

@Service
public class OrderService {

    private final UserService userService;        // 직접 의존성
    private final ProductService productService;  // 직접 의존성

    public Order createOrder(CreateOrderRequest request) {
        User user = userService.findById(request.getUserId());              // 내부 메서드 호출
        Product product = productService.findById(request.getProductId());  // 내부 메서드 호출

        // ... 주문 처리 로직
    }
}
```

#### After: 서비스 간 HTTP 통신

```java

@Service
public class OrderService {

    private final UserServiceClient userServiceClient;        // HTTP 클라이언트
    private final ProductServiceClient productServiceClient;  // HTTP 클라이언트

    public Order createOrder(CreateOrderRequest request) {
        User user = userServiceClient.getUser(request.getUserId());                 // HTTP 호출
        Product product = productServiceClient.getProduct(request.getProductId());  // HTTP 호출

        // ... 주문 처리 로직
    }
}
```

<br />

### 서비스 간 HTTP 통신

#### 1. 루트 build.gradle 업데이트

- Spring Cloud Eureka Client
    - 서비스를 Eureka Server에 자동 등록
- Spring Cloud OpenFeign
    - 선언적 HTTP 클라이언트 제공
    - 인터페이스만 정의하면 런타임 시점에 HTTP 호출 코드를 자동 생성
    - Eureka와 연동하여 서비스 이름으로 동적 라우팅
- BOM (Bill of Materials)
    - 버전 관리의 일관성을 보장하는 메커니즘
    - 호환되는 라이브러리 버전들을 미리 정의해놓은 명세서

```groovy
// Spring Cloud 버전 관리
ext {
    springCloudVersion = "2024.0.0"
    testcontainersVersion = "1.19.7"
}

subprojects {
    dependencies {
        // --- MSA (Spring Cloud) 공통 의존성 ---
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
        implementation 'org.springframework.cloud:spring-cloud-starter-openfeign'
    }

    dependencyManagement {
        imports {
            mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
            mavenBom "org.testcontainers:testcontainers-bom:${testcontainersVersion}"
        }
    }
}
```

<br />

#### 2. application.yml 업데이트

```yaml
server:
  port: 8081

spring:
  application:
    name: user-service  # Eureka에서 사용할 서비스 명

  # datasource, jpa, ... 

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
```

<br />

#### 3. OrderApplication 클래스 수정

```java

@SpringBootApplication
@EnableFeignClients  // Feign 클라이언트 활성화
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

}
```

<br />

#### 4. Feign Client 인터페이스 생성

Feign Client는 HTTP 호출 코드를 자동으로 생성해주는 선언적 웹 서비스 클라이언트입니다.

- 런타임 시점에 실제 HTTP 호출을 수행하는 구현체를 동적으로 생성
- 호출 시 : userClient.getUser(1L) → GET http://user-service/api/users/1

```java

@FeignClient(name = "service-user") // name : Eureka에서 찾을 서비스 이름 
public interface UserServiceClient {

    @GetMapping("/api/users/{id}")
    UserDto getUser(@PathVariable("id") Long id);
}
```

구현체 동적 생성 예시

```java
private WebClient webClient;

@Override
public UserDto getUser(Long id){
        // @GetMapping("/api/users/{id}") 분석
        // → HTTP GET 요청 생성
        return webClient.get()
        .uri("/api/users/{id}",id)
        .retrieve()
        .bodyToMono(UserDto.class)
        .block();
        }
```

<br />

#### 5. OrderService 수정

```java

@Service
public class OrderService {

    private final UserServiceClient userServiceClient;
    private final ProductServiceClient productServiceClient;

    public Order createOrder(CreateOrderRequest request) {
        User user = userServiceClient.getUser(request.getUserId());
        Product product = productServiceClient.getProduct(request.getProductId());

        // ... 주문 처리 로직
    }
}
```

<br />

### Eureka Server 구성

Eureka Server는 MSA 환경에서 각 서비스 정보를 등록하고, 서비스 디스커버리를 제공하는 서버입니다.

- 서비스 등록
    - 각 마이크로서비스가 시작될 때 자신의 정보(이름, IP, 포트)를 Eureka에 등록
- 서비스 발견 (Service Discovery)
    - 클라이언트가 특정 서비스를 호출할 때 해당 서비스의 위치 정보를 제공
    - 서비스 이름을 실제 IP:Port로 변환
- 헬스 체크
    - 등록된 서비스들의 상태를 주기적으로 확인

<br />

#### 1. 아키텍처 구성

```text
                    ┌───────────────────┐
                    │   Eureka Server   │ :8761
                    │ (Service Registry)│
                    └─────────┬─────────┘
                              │
                              │ 서비스 등록/발견
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
    ┌──────▼──────┐    ┌──────▼──────┐    ┌──────▼──────┐
    │User Service │    │Order Service│    │   Product   │
    │    :8081    │    │    :8083    │    │Service :8082│
    └─────────────┘    └──────┬──────┘    └─────────────┘
                              │
                              │ HTTP 통신
                              │
                    ┌─────────▼─────────┐
                    │  User/Product API │
                    │        호출        │
                    └───────────────────┘
```

<br />

#### 2. eureka-server 프로젝트 구조

```
ecommerce-monolith-to-msa/
├── build.gradle
├── settings.gradle
├── services/
│   ├── service-user/
│   ├── service-product/
│   └── service-order/
├── eureka-server/
│   ├── build.gradle
│   ├── src/main/java/com/ecommerce/eureka/
│   │   └── EurekaServerApplication.java
│   ├── src/main/resources/
└── └── └── application.yml
```

<br />

#### 3. 기본 구성

```groovy
// build.gradle

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
}
```

```yaml
# application.yml

server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: false  # 자기 자신은 등록하지 않음
    fetch-registry: false        # 다른 서비스 정보를 가져오지 않음
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
  server:
    enable-self-preservation: false  # 개발 환경에서는 비활성화
```

```java
// EurekaServerApplication.java

@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

<br />

### API 테스트

```http request
### 사용자 등록
POST http://localhost:8081/api/users
Content-Type: application/json

{
  "name": "홍길동",
  "email": "home@test.com",
  "password": "123"
}

### 상품 등록
POST http://localhost:8082/api/products
Content-Type: application/json

{
  "name": "아이폰",
  "price": "1000000",
  "stockQuantity": 10
}

### 주문 등록
POST http://localhost:8083/api/orders/users/1
Content-Type: application/json

[{
  "productId": 1,
  "quantity": 1
}]
```

<br />

#### 참고 자료

- Claude.ai 대화 내용
- Eureka Server 아키텍처 구성 이미지 (Claude.ai 대화 내용)