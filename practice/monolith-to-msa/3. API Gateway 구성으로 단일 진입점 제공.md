### 3. API Gateway 구성으로 단일 진입점 제공

- API 게이트웨이는 마이크로서비스 아키텍처의 단일 진입점(Single Point of Entry) 역할을 수행합니다.
- 클라이언트의 모든 요청을 게이트웨이가 받아서 인증, 로깅 등 공통 기능을 처리한 후, 요청에 맞는 적절한 내부 서비스로 라우팅해주는 프록시 서버입니다.

```mermaid
                   ┌─────────────────────┐
                   │   Eureka Server     │ :8761
                   └─────────┬───────────┘
                             │
                        서비스 등록/발견
                             │
┌─────────────┐    ┌─────────▼───────────┐    ┌──────────────────┐
│   Client    │───→│    API Gateway      │───→│ User Service     │ :8081
│             │    │       :8080         │    │ /api/users/**    │
└─────────────┘    │                     │    └──────────────────┘
                   │     라우팅/인증/로깅    │
                   │     로드밸런싱/필터링    │    ┌──────────────────┐
                   │                     │───→│ Order Service    │ :8082
                   └─────────────────────┘    │ /api/orders/**   │
                                              └──────────────────┘
                                              
                                              ┌──────────────────┐
                                              │ Product Service  │ :8083
                                              │ /api/products/** │
                                              └──────────────────┘
```

<br />

### API Gateway의 역할

MSA에서 API Gateway는 단순한 라우팅을 넘어 다음과 같은 기능을 담당합니다.

- 요청 라우팅 : 클라이언트의 요청을 적절한 마이크로서비스로 전달
- 인증 필터 : JWT 토큰 검증 및 사용자 정보 헤더 전달
- 공통 기능 처리 : 로깅, 요청/응답 변환, 서킷 브레이커, 사용량 제한(Rate Limiting) 등의 횡단 관심사를 처리
- 부하 분산(Load Balancing) : 서비스 인스턴스가 여러 개일 때 로드 밸런싱

<br />

### API Gateway 구축

#### 1. 게이트웨이 모듈 생성 및 의존성 추가

```text
ecommerce-monolith-to-msa/
├── build.gradle
├── settings.gradle
├── services/
│   ├── user-service/                   # 모듈명 변경 (service-* -> *-service)
│   ├── product-service/
│   └── order-service/
├── eureka-server/
├── api-gateway/                        # 새로 추가
│   ├── src/main/java/com/ecommerce/gateway/
│   │   └── ApiGatewayApplication.java
│   ├── src/main/resources/
└── └── application.yml
```

```groovy
// settings.gradle

include 'services:api-gateway' // 추가
```

```groovy
// build.gradle

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
}
```

<br />

#### 2. application.yml 설정

- 게이트웨이의 핵심 기능인 라우팅 규칙을 설정합니다.

```yaml
# src/main/resources/application.yml

server:
  port: 8080 # 게이트웨이 서버 포트

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka/ # 유레카 서버 주소

spring:
  application:
    name: gateway-service # 유레카에 등록될 게이트웨이 서비스 이름

  cloud:
    gateway:
      routes:
        # User Service 라우팅 설정
        - id: user-service # 라우트의 고유 식별자
          uri: lb://USER-SERVICE # 유레카에 등록된 서비스 이름으로 찾아감 (load-balanced)
          predicates:
            - Path=/api/users/** # 이 경로 패턴으로 요청이 오면 이 라우트를 적용

        # Product Service 라우팅 설정
        - id: product-service
          uri: lb://PRODUCT-SERVICE
          predicates:
            - Path=/api/products/**

        # Order Service 라우팅 설정
        - id: order-service
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/api/orders/**
```

<br />

#### 3. 게이트웨이 활성화

```groovy
// ApiGatewayApplication.java

@SpringBootApplication
public class ApiGatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(ApiGatewayApplication.class, args);
    }
}
```

<br />

#### 4. API 테스트

- Gateway를 통한 호출 -> http://localhost:8080

```http request
### 사용자 등록
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "name": "홍길동",
  "email": "home@test.com",
  "password": "123"
}

### 상품 등록
POST http://localhost:8080/api/products
Content-Type: application/json

{
  "name": "아이폰",
  "price": "1000000",
  "stockQuantity": 10
}

### 주문 등록
POST http://localhost:8080/api/orders/users/1
Content-Type: application/json

[{
  "productId": 1,
  "quantity": 1
}]
```

<br />

### 관련 코드

- https://github.com/khghouse/ecommerce-monolith-to-msa

<br />

#### 참고 자료

- Claude.ai 대화 내용